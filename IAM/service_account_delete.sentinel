import "tfplan"

# Define the policy
main = rule {
  all tfplan.resources as _, resource {
    is_service_account(resource) and not contains_delete_role(resource)
  }
}

# Helper function to check if the resource is a service account
is_service_account = func(resource) {
  resource.type is "google_service_account"
}

# Helper function to check if "delete" role exists in roles list
contains_delete_role = func(resource) {
  roles = resource.attributes["roles"]
  roles_contains_delete = false
  if roles != null and type(roles) == type([]) {
    for roles as _, role {
      if role contains "delete" {
        roles_contains_delete = true
        break
      }
    }
  }
  roles_contains_delete
}
